<include file="Common:header"/>
<!--BEGIN FORM STYLE-->
<link rel="stylesheet" href="__PLUG__/Uploadify/uploadify.css" />
<link rel="stylesheet" type="text/css" href="__METRONIC_CSS__/datepicker.css" />
<link rel="stylesheet" type="text/css" href="__METRONIC_CSS__/daterangepicker.css" />
<link rel="stylesheet" type="text/css" href="__METRONIC_CSS__/datetimepicker.css" />
<link href="__METRONIC_CSS__/bootstrap-modal.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="__PLUG__/Uploadify/jquery.uploadify.min.js"></script>
<link rel="stylesheet" href="//apps.bdimg.com/libs/jqueryui/1.10.4/css/jquery-ui.min.css">
<script src="//apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>
<!--END FORM STYLE-->
<!-- BEGIN CONTAINER -->
<div class="page-container">
    <!-- BEGIN SIDEBAR -->
    <include file="Common:nav"/>
    <!-- END SIDEBAR -->
    <!-- BEGIN PAGE -->
    <div class="page-content fill-content">
        <!-- BEGIN PAGE CONTAINER-->
        <div class="container-fluid">
            <!-- BEGIN PAGE HEADER-->
            <div class="row-fluid">
                <div class="span12">
                    <!-- BEGIN PAGE TITLE & BREADCRUMB-->
                    <h3 class="page-title">
                        Dashboard <small>statistics and more</small>
                    </h3>
                    <ul class="breadcrumb">
                        <li>
                            <i class="icon-home"></i>
                            <a href="{:U('Index/index')}">首页</a>
                            <i class="icon-angle-right"></i>
                        </li>
                        <li>
                            <php>
                                $column = M('column')->find($_GET['id']);
                            </php>
                            <a href="__URL__/index?id={$Think.get.id}">{$column.title}</a>
                        </li>
                        <li class="pull-right no-text-shadow">
                            <div id="dashboard-report-range" class="dashboard-date-range tooltips no-tooltip-on-touch-device responsive"
                                 data-tablet="" data-desktop="tooltips" data-placement="top" data-original-title="Change dashboard date range">
                                <i class="icon-calendar"></i>
                                <span></span>
                                <i class="icon-angle-down"></i>
                            </div>
                        </li>
                    </ul>
                    <!-- END PAGE TITLE & BREADCRUMB-->
                </div>
            </div>
            <!-- END PAGE HEADER-->
            <!--BEGIN PAGER FORM-->
            <div class="row-fluid">
                <div class="span12">
                    <div class="portlet box purple">
                        <div class="portlet-title">
                            <div class="caption"><i class="icon-reorder"></i>{$model.name|default='添加广告'}</div>
                            <div class="tools">
                                <a href="javascript:;" class="collapse"></a>
                                <a href="#portlet-config" data-toggle="modal" class="config"></a>
                                <a href="javascript:;" class="reload" data-role="__METRONIC_IMG__/fancybox_loading.gif" data-form="form_sample_1" data-reset="1"></a>
                                <a href="javascript:;" class="remove"></a>
                            </div>
                        </div>
                        <div class="portlet-body form">
                            <!-- BEGIN FORM-->
                            <form action="__URL__/add_ad" method="post" id="form_sample_4" class="form-horizontal" novalidate="novalidate"  enctype="multipart/form-data">
                                <div class="alert alert-error hide">
                                    <button class="close" data-dismiss="alert"></button>
                                    	请填写完表单在提交
                                </div>
                                <div class="alert alert-success hide">
                                    <button class="close" data-dismiss="alert"></button>
                                    	请填写完表单完成
                                </div>
                                <div class="control-group">
                                    <label class="control-label">所属栏目<span class="required">*</span></label>
                                    <div class="controls">
                                        <select name="column_id">
                                        	<option value="0">全站</option>
                                        	<volist name="column_list" id="cate">
                                                <option value="{$cate.id}">{$cate.html}{$cate.title}</option>
                                            </volist>
                                        </select>
                                    </div>
                                </div>
                                <div class="control-group">
                                    <label class="control-label">礼券类型<span class="required">*</span></label>
                                    <div class="controls">
                                        <select name="coupons_type" id="coupons_type">
						                    <option value="-1">--请选择类型--</option>
						                    <option value="0">实物</option>
						                    <option value="1">折扣</option>
						                    <option value="2">现金</option>
						                </select>
                                    </div>
                                </div>
                                <div class="control-group">
                                    <label class="control-label">礼券名称<span class="required">*</span></label>
                                    <div class="controls">
                                        <input type="text" name="coupons_title" id="control-name" data-required="1" class="span4 m-wrap" placeholder="标题" value="{$article.coupons_title}">
                                        <input type="hidden" value="{$Think.get.p}" name="p">
                                        <input type="hidden" value="{$article.id}" name="id">
                                    </div>
                                </div>
                                <div class="control-group">
                                    <label class="control-label">礼券面值<span class="required">*</span></label>
                                    <div class="controls">
                                        <span id="coupons_val_type"><input name="coupons_val" type="text"  class=""></span>
                                    </div>
                                </div>
                                <div class="control-group" id="coupons_val_cls" style="display:none;">
                                    <label class="control-label">对应商品<span class="required">*</span></label>
                                    <div class="controls">
                                        
                                    </div>
                                </div>
                                <div class="control-group" id="coupons_sum">
                                    <label class="control-label">生成数量<span class="required">*</span></label>
                                    <div class="controls">
                                        <input name="coupons_sum" type="text" id="coupons_sum" value=""  class="required">
                                    </div>
                                </div>
                                <div class="control-group">
                                    <label class="control-label">说明</label>
                                    <div class="controls">
                                        <textarea name="description" class="span4 m-wrap" placeholder="说明">{$article.description}</textarea>
                                    </div>
                                </div>
                                <div class="form-actions">
                                    <button type="submit" class="btn purple">提交</button>
                                    <button type="button" class="btn" onclick="window.history.go(-1);">返回</button>
                                </div>
                            </form>
                            <!-- END FORM-->
                        </div>
                    </div>
                </div>
            </div>
            <!--END PAGER FORM-->
        </div>
        <!-- END PAGE CONTAINER-->
    </div>
    <!-- END PAGE -->
</div>
<!-- END CONTAINER -->
<!-- BEGIN PAGE LEVEL PLUGINS -->
<script type="text/javascript" src="__METRONIC_JS__/jquery.validate.min.js"></script>
<script type="text/javascript" src="__METRONIC_JS__/additional-methods.min.js"></script>
<script type="text/javascript" src="__METRONIC_JS__/select2.min.js"></script>
<script type="text/javascript" src="__METRONIC_JS__/chosen.jquery.min.js"></script>
<script type="text/javascript" src="__METRONIC_JS__/bootstrap-datepicker.js"></script>
<!-- END PAGE LEVEL PLUGINS -->
<!-- BEGIN PAGE LEVEL STYLES -->
<script type="text/javascript" src="__METRONIC_JS__/form-validation.js"></script>
<script type="text/javascript" src="__METRONIC_JS__/form-checked.js"></script>
<script type="text/javascript">
    $(function(){
    	$( "#datepicker" ).datepicker({
    		showButtonPanel:true,//是否显示按钮面板  
            dateFormat: 'yy-mm-dd',//日期格式  
            clearText:"清除",//清除日期的按钮名称  
            closeText:"关闭",//关闭选择框的按钮名称  
            monthNames: ['一月','二月','三月','四月','五月','六月','七月','八月','九月','十月','十一月','十二月'],  
            dayNames: ['星期日','星期一','星期二','星期三','星期四','星期五','星期六'],  
            dayNamesShort: ['周日','周一','周二','周三','周四','周五','周六'],  
            dayNamesMin: ['日','一','二','三','四','五','六'], 
    	});
        $('#form_sample_4').validate({
            errorElement: 'span', //default input error message container
            errorClass: 'help-inline', // default input error message class
            focusInvalid: false, // do not focus the last invalid input
            ignore: "",
            rules: {
                title: {
                    required: true
                },
                url:{
                    required:true,
                    url:true
                }
            },
            messages: { // custom messages for radio buttons and checkboxes
                title: {
                    required: "字段不能为空"
                },
                url: {
                    required: "字段不能为空",
                    url:'格式不正确'
                }
            },
            highlight: function (element) { // hightlight error inputs
                $(element)
                        .closest('.help-inline').removeClass('ok'); // display OK icon
                $(element)
                        .closest('.control-group').removeClass('success').addClass('error'); // set error class to the control group
            },

            unhighlight: function (element) { // revert the change dony by hightlight
                $(element)
                        .closest('.control-group').removeClass('error'); // set error class to the control group
            },

            success: function (label) {
                label
                        .addClass('valid').addClass('help-inline ok') // mark the current input as valid and display OK icon
                        .closest('.control-group').removeClass('error').addClass('success'); // set success class to the control group
            }
        });

        $('#form_sample_4').submit(function(e){
            e.preventDefault();
            if($('#coupons_type').val()==-1){
               layer.msg('请选择礼券类型',{icon:11});
               return false;
            }
            if($('#coupons_sum').val() == 0 ){
               layer.msg('请选择生成实物券栏目',{icon:11});
               return false;
            }
            if($('#coupons_val').val()<=0){
               layer.msg('请选择生成实物券数目',{icon:11});
               return false;
            }
            if($('#form_sample_4').valid()){
                $.post($('#form_sample_4').attr('action'),$('#form_sample_4').serialize(),function (data) {
                    if(data.status==1){
                        layer.alert(data.msg,{icon:2,end:function () {
                            location.href = data.redirect;
                        }});
                    }else {
                        layer.alert(data.msg,{icon:5});
                    }
                });
            }
        });
        
        $('#coupons_type').change(function () {
           var val = $(this).val();
           switch (val){
               case "0":
                   $('#coupons_val_type').siblings('em').text('对应栏目');
                   $('#coupons_pre').hide();
                   $.post('__URL__/get_columns',function (data) {
                       if(data.status==1){
                           $('#coupons_val_type').empty().html(data.result);
                       }else{
                           layer.msg(data.msg,{icon:11});
                       }
                   });
                   break;
               case "1":
               case "2":
                   $('#coupons_val_type').siblings('em').text('礼券面值');
                   $('#coupons_val_type').empty().append('<input name="coupons_val" type="text" class="required">');
                   $('#coupons_pre').show();
                   $('#coupons_val_cls').hide();
                   break;
           }
       });
    });
    function imgView(pic_url){
        if(pic_url == 'master'){
            pic_url = $('#reply_img').val();
        }
        if(pic_url==''){
            layer.alert('你还没有上传图片',{icon:11});
            return false;
        }
        layer.open({
            type: 1,
            title: '查看图片',
            skin: 'layui-layer-rim', //加上边框
            area: ['500px', '400px'], //宽高
            content: "<div style='max-width:500px; max-height:400px; overflow:auto;'><img style='max-width:500px; max-height:400px; overflow:auto;' src='"+pic_url+"'  /></div>"
        });
    }

    //照片
    $("#fileImg").uploadify({
        fileTypeDesc    : '图片文件',
        fileTypeExts    : '*.png;*.jpg;*.jpeg;*.gif;',
        buttonText      : '选择图片',
        buttonClass     : 'upload_button',
        swf             : '__PLUG__/Uploadify/uploadify.swf',
        uploader        : "{:U('Uploadify/uploadImg')}",
        multi           : false,
        onUploadSuccess : function(file, data, response) {
            $("#reply_img").val(data);
            $("#images_preview").attr('src',data);
            $('#images_preview').show();
            $('#img_b').show();
            $('#img_c').show();
        }
    });
    function noMasterImg(){
        $src = $("#images_preview").attr('src');
        if($src==''){
            layer.alert('您好没有上传图片',{icon:11});
            return false;
        }
        $.post("{:U('Uploadify/delmg')}",{src:$src},function(data){
            if(data.status==1){
                layer.msg(data.msg,{icon:1});
                $("#reply_img").val('');
                $('#images_preview').attr('src','');
                $('#img_c').hide();
                $('#images_preview').hide();
            }else{
                layer.alert(data.msg,{icon:11});
            }
        });
    }
    function deleteImage(obj) {
        var url = $(obj).attr('data-path');
        if(url==''){
            layer.alert('删除图片不存在',{icon:2});
        }
        var index = layer.load(2, {
            shade: [0.4,'#fff'] //0.1透明度的白色背景
        });
        $.post("{:U('Uploadify/delmg')}",{src:url},function(data){
            if(data.status==1){
                layer.msg(data.msg,{icon:1,end:function () {
                    layer.closeAll();
                    $(obj).parent('span.imageDiv').remove();
                }});
            }else{
                layer.msg(data.msg,{icon:5});
            }
        });
    }
    /**
    * 获取目标数量
    * @param obj
    */
    function changeVal(obj) {
        var o = $(obj);
        var val =o.val();
        if(val==-1){
            layer.msg('请选择生成实物券的栏目',{icon:2});
        }
        $.post('__URL__/get_article_list',{cid:val},function (data) {
            if(data.status==1){
                $('#coupons_val_cls').empty().append("<em>对应商品</em>"+data.result);
                $('#coupons_val_cls').show();
                //$('#coupons_sum').val(data.result);
            }else{
                layer.msg(data.msg,{icon:2});
                $('#coupons_val_cls').empty().append("<em>对应商品</em>");
                $('#coupons_sum').val(0);
            }
        });
    }

    function changeVals(obj) {
        var o = $(obj);
        var val =o.val();
        if(val==-1){
            layer.msg('请选择产品',{icon:2});
        }
        $.post('__URL__/get_article_count',{cid:val},function (data) {
            if(data.status==1){
                $('#coupons_sum').val(data.result);
            }else{
                layer.msg(data.msg,{icon:2});
                $('#coupons_sum').val(0);
            }
        });
    }
</script>
<!-- END PAGE LEVEL STYLES -->
<include file="Common:footer"/>